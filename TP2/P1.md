# Partie 1 : Premiers pas Azure

- [I. Premiers pas](#i-premiers-pas)
- [II. cloud-init](#ii-cloud-init)

# I. Premiers pas

üåû **Cr√©ez une VM depuis la WebUI**

**Modification des param√®tres de base et ajout de la cl√© publique de ma machine.**

üåû **Cr√©ez une VM depuis le Azure CLI**

```bash
vm create --name secondvm --resource-group efreitp2 --location northeurope --admin-username dorian --size Standard_B1s --image Ubuntu2204 --ssh-key-values .ssh/id_rsa.pub 
```

‚ûú **Assurez-vous que vous pouvez vous connecter √† la VM en SSH sur son IP publique.**

- une fois connect√©, observez :
  - **la pr√©sence du service `walinuxagent`**
    - permet √† Azure de monitorer et interagir avec la VM

```bash
dorian@firstvm:~$ dpkg -l | grep walinuxagent
ii  walinuxagent                           2.2.46-0ubuntu5.1                       amd64        Windows Azure Linux Agent
```
      
  - **la pr√©sence du service `cloud-init`**
    - permet d'effectuer de la configuration automatiquement au premier lancement de la VM
    - c'est lui qui a cr√©√© votre utilisateur et nov votre cl√© pour se co en SSH !
    - vous pouvez v√©rifier qu'il s'est bien d√©roul√© avec la commande `cloud-init status`

```bash
dorian@firstvm:~$ cloud-init status
status: done
```

üåû **Cr√©ez deux VMs depuis le Azure CLI**

```bash
dorian@secondvm:~$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:0d:3a:b0:56:b4 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.5/24 metric 100 brd 10.0.0.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::20d:3aff:feb0:56b4/64 scope link 
       valid_lft forever preferred_lft forever
```

```bash
dorian@firstvm:~$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:0d:3a:69:d1:66 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.4/24 metric 100 brd 10.0.0.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::20d:3aff:fe69:d166/64 scope link 
       valid_lft forever preferred_lft forever
dorian@firstvm:~$ ping 10.0.0.5
PING 10.0.0.5 (10.0.0.5) 56(84) bytes of data.
64 bytes from 10.0.0.5: icmp_seq=1 ttl=64 time=2.95 ms
64 bytes from 10.0.0.5: icmp_seq=2 ttl=64 time=1.13 ms
^C
--- 10.0.0.5 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 1.128/2.036/2.945/0.908 ms
```

# II. cloud-init

‚ûú **Sur votre PC, cr√©ez un fichier `cloud-init.txt` avec le contenu suivant :**

```yml
 #cloud-config
users:
  - name: dorian
    primary_group: dorian
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    passwd: $6$ZAqh.6JfzbDfRbzO$FAYekeU7Ng005DZJOEyrY3yV.XLAYO0oiYak6kkb4bhc3FS3sklb14VGM2nswaiQS3r7orG00IKAfmKPf6oof0
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC3zWWEqew60VcjLMArl1+f9Ysr62B7uz33wVyn2hVYTTOXs51CJkSqTPfiK4htfMeImvlOhKmZVjQBxmy/4BMfNZw99Ra1sp0b47UfYJFnPwBRU9nvHaexRcT23tLEkle+5RRoGTo5P2++Frog2RdWQ5jjQDwg8zCnnNMYAbtgEvqNjunN8TrXluSlJ4bTk7Qwz2PsDX/oDJbhL8ChTiFWyMVZzCVO57ZJzcVmlUGT3kNFmEDGNCbKoLdglrbuMOfX5tMNtcXWG8/JdJQXdB7mQga/mbk/AQ+sUKCOcRCOrIWHxBsztzfmYq3eEIRATeQg0XK+GAzY8Oj56amWoORl dorian@MacBook-Air-de-Dorian.local
```

üåû **Tester `cloud-init`**

```bash
vm create --custom-data Desktop/cloud-init.txt --name cloudinit  --resource-group efreitp2 --location northeurope --size Standard_B1s --image Ubuntu2204
```

üåû **V√©rifier que `cloud-init` a bien fonctionn√©**

- connectez-vous en SSH √† la VM nouvellement cr√©√©e
- vous devriez observer qu'un nouvel utilisateur a √©t√© cr√©√©, avec le bon password et la bonne cl√©
