# Partie 2 : Cr√©er et utiliser une image custom

- [Partie 2 : Cr√©er et utiliser une image custom](#partie-2--cr√©er-et-utiliser-une-image-custom)
- [I. Cr√©ation image custom](#i-cr√©ation-image-custom)
  - [1. Cr√©er une VM](#1-cr√©er-une-vm)
  - [2. Configurer la VM](#2-configurer-la-vm)
  - [3. Cr√©er une image custom](#3-cr√©er-une-image-custom)
  - [3. Cr√©er une nouvelle VM](#3-cr√©er-une-nouvelle-vm)
- [II. Tester : sp√©cialiser les VMs au lancement](#ii-tester--sp√©cialiser-les-vms-au-lancement)
- [Bilan et cleanup](#bilan-et-cleanup)

## I. Cr√©ation image custom

### 1. Cr√©er une VM

üåû **Cr√©ez une VM**

```bash
vm create --custom-data Desktop/cloud-init.txt --name cloudinit  --resource-group efreitp2 --location northeurope --size Standard_B1s --image Ubuntu2204
```

```yml
 #cloud-config
users:
  - name: dorian
    primary_group: dorian
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    passwd: $6$WVuXmZQgrX5j02Vk$EoAKMnZWDIe9/m33ogMo52qdDTGcRMpN4sajjo8xci.Q2SlXA5O1fRb5pn8rT2OHyzd.f.bBoTxIRhVD9NvEM0
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC3zWWEqew60VcjLMArl1+f9Ysr62B7uz33wVyn2hVYTTOXs51CJkSqTPfiK4htfMeImvlOhKmZVjQBxmy/4BMfNZw99Ra1sp0b47UfYJFnPwBRU9nvHaexRcT23tLEkle+5RRoGTo5P2++Frog2RdWQ5jjQDwg8zCnnNMYAbtgEvqNjunN8TrXluSlJ4bTk7Qwz2PsDX/oDJbhL8ChTiFWyMVZzCVO57ZJzcVmlUGT3kNFmEDGNCbKoLdglrbuMOfX5tMNtcXWG8/JdJQXdB7mQga/mbk/AQ+sUKCOcRCOrIWHxBsztzfmYq3eEIRATeQg0XK+GAzY8Oj56amWoORl dorian@MacBook-Air-de-Dorian.local
  ```

### 2. Configurer la VM

üåû **Installer docker √† la machine**

[Utilisation de la Doc par Docker](https://docs.docker.com/engine/install/ubuntu/)

```bash
dorian@cloudinit:~$ sudo systemctl enable docker.socket
```

```bash
dorian@cloudinit:~$ sudo systemctl status docker.socket 
‚óè docker.socket - Docker Socket for the API
     Loaded: loaded (/lib/systemd/system/docker.socket; enabled; vendor preset:>
     Active: active (running) since Fri 2024-01-12 10:08:28 UTC; 40min ago
   Triggers: ‚óè docker.service
     Listen: /run/docker.sock (Stream)
      Tasks: 0 (limit: 995)
     Memory: 0B
        CPU: 491us
     CGroup: /system.slice/docker.socket
```

üåû **Am√©liorer la configuration du serveur SSH**

- Modification du port par d√©faut (Port)
- D√©sactivation la connexion avec root (PermitRootLogin)
- D√©sactiver l'authentification par mot de passe (PasswordAuthentication)
- Configurer un d√©lai d'inactivit√© (ClientAliveInterval)

*Attention au changement de port, il faut √©galement changer le port sur le groupe de s√©curit√© r√©seau de Azure*

> Il y a √©galement d'autre solution plus pouss√©

- Autoriser certaines IP √† pouvoir se connecter au serveur SSH en utilisant le pare-feu
- Installer un service de fail2ban et faire une configuration au petit oignons

üåû **Une fois que tout est fait : g√©n√©raliser la VM**

- ce qu'on appelle "*g√©n√©raliser*" c'est le fait de la remettre dans un √©tat comme si elle n'avait jamais √©t√© lanc√©e
- comme √ßa, elle pourra servir de base √† la cr√©ation d'autres VMs (c'est le but !)
- les √©tapes :
  - reset la conf r√©seau
  - on reset `cloud-init` pour qu'il se relance au prochain boot
  - on reset l'agent Azure (`wagent`) pour qu'il se lance au prochaine boot comme un premier boot
  - on supprime l'historique de commandes

```bash
# Suppression des confs r√©seau qui auraient pu √™tre cr√©√©es au premier boot
sudo rm -f /etc/cloud/cloud.cfg.d/50-curtin-networking.cfg /etc/cloud/cloud.cfg.d/curtin-preserve-sources.cfg /etc/cloud/cloud.cfg.d/99-installer.cfg /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg
sudo rm -f /etc/cloud/ds-identify.cfg
sudo rm -f /etc/netplan/*.yaml

# Conf d√©j√† effectu√©e normalement mais au cas o√π : on demande √† l'agent Azure d'utiliser cloud-init
sudo sed -i 's/Provisioning.Enabled=y/Provisioning.Enabled=n/g' /etc/waagent.conf
sudo sed -i 's/Provisioning.UseCloudInit=n/Provisioning.UseCloudInit=y/g' /etc/waagent.conf
sudo sed -i 's/ResourceDisk.Format=y/ResourceDisk.Format=n/g' /etc/waagent.conf
sudo sed -i 's/ResourceDisk.EnableSwap=y/ResourceDisk.EnableSwap=n/g' /etc/waagent.conf
cat <<EOF | sudo tee -a /etc/waagent.conf
Provisioning.Agent=auto
EOF

# On reset cloud-init
sudo cloud-init clean --logs --seed
sudo rm -rf /var/lib/cloud/

# On reset l'agent Azure
sudo systemctl stop walinuxagent.service
sudo rm -rf /var/lib/waagent/
sudo rm -f /var/log/waagent.log
sudo waagent -force -deprovision+user

# Suppression de l'historique de commande
sudo rm -f ~/.bash_history
```

‚ûú **VM pr√™te !**

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è **√âteignez la VM avant de continuer** (depuis la WebUI Azure ou avec `az`) **puis saisisse les commandes suivantes :** ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

```bash
# supprimer les ressources attribu√©es √† la VM
az vm deallocate --resource-group <RESOURCE_GROUP> --name <VM_NAME> 

# transformer la VM en une VM "g√©n√©ralis√©e" (n√©cessaire pour en faire une image pour la suite)
az vm generalize --resource-group <RESOURCE_GROUP> --name <VM_NAME> 
```

### 3. Cr√©er une image custom

Pour √ßa il faut respecter le mod√®le d√©fini par Azure, √† savoir :

- cr√©er une Galerie d'images
  - on y stockera notre image custom
- cr√©er une D√©finition d'image
  - c'est genre dire qu'on a une image qui s'appelle "super-toto" par exemple
- cr√©er une Version d'image
  - c'est indiquer qu'il existe une version "1.0.0" √† "super-toto"
  - et on indique aussi que cette version utilise un disque dur pr√©cis
  - ce disque dur, ce sera celui de la VM cr√©√©e pr√©c√©demment

üåû **Pour √ßa, suivez les commandes `az` suivantes :**

```bash
# Rep√©rez le nom de votre VM pr√©c√©demment cr√©√©e
az vm list --output table

# Rep√©rez l'ID de la VM, il est sous la forme :
# /subscriptions/<ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/virtualMachines/<VM_NAME>
az vm get-instance-view -g <RESOURCE_GROUP> -n <VM_NAME>

# Cr√©er une galerie d'image
az sig create \
   --resource-group efreitp2 \
   --gallery-name efreigallery \

# Cr√©er une d√©finition d'image
az sig image-definition create \
   --resource-group efreitp2 \
   --gallery-name efreigallery \
   --gallery-image-definition efreidef \
   --publisher efreipub \
   --offer efreioffer \
   --sku efreisku \
   --os-type Linux \
   --os-state Generalized \
   --hyper-v-generation V2 \
   --features SecurityType=TrustedLaunch

# Publier une version de l'image
# c'est l√† qu'on pr√©cise qu'on se sert de la VM d'avant comme base
# apr√®s --managed-image, remplacez par l'ID que vous avez r√©cup√©r√© plus t√¥t
az sig image-version create \
   --resource-group efreitp2 \
   --gallery-name efreigallery \
   --gallery-image-definition efreidef \
   --gallery-image-version 1.0.0 \
   --target-regions "francecentral" \
   --replica-count 1 \
   --managed-image "/subscriptions/<ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/virtualMachines/<VM_NAME>"
```

‚ûú **Notez bien l'ID de l'image une fois que cette derni√®re commande est pass√©e**

- dans le retour de la commande sera indiqu√© l'ID de l'image
- l'ID est sous la forme :

```weird
"/subscriptions/<ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY>/images/<DEFINITION>/versions/1.0.0"
```

> *Toutes les op√©rations se d√©roule sur Azure, si √ßa prend pas tu temps, √ßa d√©pend pas de votre connexion actuelle sur votre PC.*

## 3. Cr√©er une nouvelle VM

```bash
# on cr√©e un nouvelle VM en indiquant qu'on veut utiliser notre nouvelle image comme base
# on cr√©e un user et on d√©pose une cl√© publique √† la cr√©ation de la vm
az vm create \
    --resource-group efreitp2 \
    --name prout \
    --image "/subscriptions/<ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY>/images/<DEFINITION>/versions/1.0.0" \
    --security-type TrustedLaunch \
    --ssh-key-values <CHEMIN_VERS_CLE_PUB> --admin-username <TON_USER>
```

- `<CHEMIN_VERS_CLE_PUB>` : le chemin vers ta cl√© publique sur ton PC
- `<TON_USER>` : nom du user que tu veux cr√©er au lancement de la machine

> C'est le service `cloud-init` qui s'occupe de cr√©er l'utilisateur et de d√©poser la cl√© publique au d√©marrage de la machine.

‚ûú **Connectez-vous en SSH √† cette nouvelle VM** et constatez :

- Docker est d√©j√† install√© et d√©marr√©
- y'a bien votre configuration SSH
- on peut donc cr√©er autant de VM qu'on veut √† partir d'une image de base ma√Ætris√©e
- `cloud-init` a bien √©t√© run

# II. Tester : sp√©cialiser les VMs au lancement

On va revenir sur `cloud-init`, cette fois, avec une image qui est d√©j√† pr√©configur√©e.

On a quelque chose d'assez puissant sous la main l√†, Docker est d√©j√† install√©, on peut donc avec quelques lignes de conf `cloud-init` d√©marrer des nouvelles VMs avec des conteneurs d√©j√† actifs quand elles s'allument.

Bien qu'on ait fait √ßa de fa√ßon sommaire, on a un truc tr√®s proche de la r√©alit√© :

- une image de base customis√©e
- un outil pour sp√©cialiser les VMs au moment o√π elles sont lanc√©es : `cloud-init`

üåû **Sur votre PC, √©crivez un fichier `cloud-init.txt`**

- r√©utiliser le fichier que je vous ai fourni plus haut pour cr√©er un user
- ajoutez √† ce fichier ce qu'il faut pour que `cloud-init` lance un conteneur NGINX :
  - ainsi, d√®s que la VM pop, PAF ! Un serveur web d√©j√† dispo dans un conteneur
  - une ligne tr√®s simple suffit, par exemple :

```bash
systemctl start docker # si c'est pas d√©j√† activ√© au d√©marrage
docker run -d -p 80:80 nginx
```

üåû **Avec une comande `az`, cr√©ez une nouvelle machine**

- elle doit utiliser notre image custom
- elle doit fournir votre fichier `cloud-init.txt` √† la VM pour que le service `cloud-init` applique son contenu
- une fois qu'elle a d√©marr√©, v√©rifiez que le serveur web tourne

‚ûú Si vous voulez visiter le site web, il sera n√©cessaire d'ouvrir un port dans le firewall Azure

- dans la WebUI :
  - aller dans la liste des VMs, cliquer sur la VM conern√©e
  - Networking > Network Settings > Ajouter une r√®gle Inbound
- [avec `az network nsg rule create`](https://learn.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest)

# Bilan et cleanup

üåû **Supprimez toutes les ressources dans votre espace Azure**

- rien √† rendre dans le TP mais je l'√©cris pour pas que vous l'oubliez !
- supprimez les VMs √©tou √©tou, pour pas consommer des cr√©dits Azure pour rien
- allez dans votre Resource Group cr√©√© au d√©but du TP, supprimez-tout, et supprimez le Resource Group

‚ûú **Une nouvelle image de VM custom**

- avec notre politique de s√©cu inclus (conf SSH, on pourrait aller bien plus loin)
- avec de quoi lancer des nouvelles applications d√®s le boot (Docker)
- cas typique d'entreprise o√π chaque VM doit contenir une conf ma√Ætris√©e

![Happy](./img/api.png)